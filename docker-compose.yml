services:
  backend:
    image: nginx:alpine
    volumes:
      - ./configs/backend/static:/usr/share/nginx/html:ro
      - ./configs/backend/nginx.conf:/etc/nginx/nginx.conf:ro
    networks: [app-network]

  nginx:
    image: nginx:latest
    ports: ["80:80", "443:443"]
    volumes:
      - ./configs/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ssl_certs:/etc/nginx/ssl:ro
    networks: [app-network]

  caddy:
    image: caddy:latest
    ports: ["81:81", "444:444"]
    volumes:
      - ./configs/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ssl_certs:/etc/caddy/ssl:ro
      - caddy_data:/data
      - caddy_config:/config
    networks: [app-network]

  traefik:
    image: traefik:latest
    command: ["--configFile=/etc/traefik/traefik.yml"]
    ports: ["82:82", "445:445"]
    volumes:
      - ./configs/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./configs/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ssl_certs:/etc/traefik/ssl:ro
    networks: [app-network]

  # Resource-constrained proxies (1 CPU core, 1GB memory)
  nginx_constrained:
    image: nginx:latest
    ports: ["9080:80", "9443:443"]
    volumes:
      - ./configs/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ssl_certs:/etc/nginx/ssl:ro
    networks: [app-network]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '2.0'
          memory: 2G

  caddy_constrained:
    image: caddy:latest
    ports: ["9081:81", "9444:444"]
    volumes:
      - ./configs/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ssl_certs:/etc/caddy/ssl:ro
      - caddy_data_constrained:/data
      - caddy_config_constrained:/config
    networks: [app-network]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '2.0'
          memory: 2G

  traefik_constrained:
    image: traefik:latest
    command: ["--configFile=/etc/traefik/traefik.yml"]
    ports: ["9082:82", "9445:445"]
    volumes:
      - ./configs/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./configs/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ssl_certs:/etc/traefik/ssl:ro
    networks: [app-network]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '2.0'
          memory: 2G

  test-runner:
    build: .
    command: sleep infinity
    volumes: [./results:/app/results]
    networks: [app-network]

networks:
  app-network:

volumes:
  caddy_data:
  caddy_config:
  caddy_data_constrained:
  caddy_config_constrained:
  ssl_certs:
